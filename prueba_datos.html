<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VISTA PREVIA (MODAL Y FILTROS)</title>
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <div id="dashboard-content" style="display: block;">
    
        <div class="header">
            <h1>üìä Panel de Control del Chatbot</h1>
            <button id="logout-btn">Cerrar Sesi√≥n</button>
        </div>
        
        <div id="status-bar">
            Estado: <span id="message">Vista previa de datos simulados (Modal activo)</span>
        </div>

        <div class="card">
            <h3>üìà M√©tricas Clave</h3>
            <p class="metric">Pedidos Cargados: <span id="pedidos-count" style="font-weight: bold; color: #00fff2;">0</span></p>
        </div>

        <div class="data-grid">
            
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üõí Pedidos</h3>
                
                <div id="filter-container">
                    
                    <label class="filter-checkbox-label">
                        <input type="checkbox" class="filter-checkbox" value="pendiente" checked> Pendientes
                    </label>

                    <label class="filter-checkbox-label">
                        <input type="checkbox" class="filter-checkbox" value="completada" checked> Completadas
                    </label>
                    
                    <label class="filter-checkbox-label">
                        <input type="checkbox" class="filter-checkbox" value="cancelada" checked> Canceladas
                    </label>
                </div>

                <div id="pedidos-list">
                    <p>Cargando pedidos simulados...</p>
                </div>
            </div>
            
        </div>
        
    </div> 

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Detalle del Pedido #</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            
            <h3 style="color: #00fff2;">Informaci√≥n del Pedido</h3>
            <p>
                Producto: <strong id="detail-product"></strong><br>
                Precio: <strong id="detail-price"></strong><br>
                Estado: <strong id="detail-status"></strong><br>
            </p>
            
            <h3 style="color: #00fff2;">Informaci√≥n del Cliente</h3>
            <p>
                Nombre: <strong id="detail-client-name"></strong><br>
                WhatsApp ID: <strong id="detail-client-id"></strong><br>
            </p>

            <h3 style="color: #c501e2;">Transcripci√≥n de la Conversaci√≥n</h3>
            <div id="detail-conversation-log">
                </div>

        </div>
    </div>

    <script>
        // ----------------------------------------------------------------------
        // 1. DATOS SIMULADOS (JSON)
        // ----------------------------------------------------------------------

        const mockData = [
            {
                id: 105,
                producto_nombre: "Oud Ispahan 100ml",
                monto: 120.00,
                estado: "Pendiente",
                fecha_pedido: "2025-11-28T09:30:00Z",
                clientes: { nombre: "Andrea Garc√≠a", numero_whatsapp: "+5491155551234" },
                logs: [{ es_entrada: true, contenido: "S√≠, por favor, me env√≠as el Oud Ispahan. ¬øC√≥mo pago?", chatbot_accion: "Confirmaci√≥n de Compra"}, { es_entrada: false, contenido: "¬°Excelente! Confirmamos que Oud Ispahan est√° en STOCK. ¬øDeseas proceder con la compra por 120‚Ç¨?", chatbot_accion: "Confirmaci√≥n de Stock"}, { es_entrada: true, contenido: "Estoy buscando el perfume Oud Ispahan. ¬øLo tienen?", chatbot_accion: "B√∫squeda de Producto"}, { es_entrada: false, contenido: "Hola Andrea! Soy el Chatbot de Perfumes √Årabes. ¬øEn qu√© puedo ayudarte hoy?", chatbot_accion: "Inicio de Conversaci√≥n"}]
            },
            {
                id: 104,
                producto_nombre: "Shaghaf Oud Aswad",
                monto: 45.00,
                estado: "Completada",
                fecha_pedido: "2025-11-27T18:45:00Z",
                clientes: { nombre: "Ricardo Perez", numero_whatsapp: "+5491166665678" },
                logs: [{ es_entrada: true, contenido: "Recibido, muchas gracias. Ya lo prob√© y me encant√≥.", chatbot_accion: "Feedback Positivo"}, { es_entrada: false, contenido: "Pedido enviado. El n√∫mero de tracking es: T4G56. Que lo disfrutes!", chatbot_accion: "Pedido Enviado"}, { es_entrada: true, contenido: "Quiero el Shaghaf Oud, ya lo compr√© antes.", chatbot_accion: "Recompra Directa"}]
            },
            {
                id: 103,
                producto_nombre: "Yatagan",
                monto: 70.00,
                estado: "Cancelada",
                fecha_pedido: "2025-11-27T10:15:00Z",
                clientes: { nombre: "Javier L√≥pez", numero_whatsapp: "+5491177779012" },
                logs: [{ es_entrada: true, contenido: "Quiero el perfume Yatagan, sino est√° no me interesa.", chatbot_accion: "Selecci√≥n √önica"}, { es_entrada: false, contenido: "Lo sentimos, Yatagan est√° agotado. ¬øDesea ver otras opciones?", chatbot_accion: "Notificar Agotado"}]
            },
            {
                id: 102,
                producto_nombre: "Oud Wood 50ml",
                monto: 250.00,
                estado: "Pendiente",
                fecha_pedido: "2025-11-28T12:00:00Z",
                clientes: { nombre: "Laura Gim√©nez", numero_whatsapp: "+5491188883456" },
                logs: [{ es_entrada: true, contenido: "El Oud Wood de 50ml. Estoy esperando el link de pago.", chatbot_accion: "Esperando Pago"}, { es_entrada: false, contenido: "Confirmo stock de Oud Wood. Costo 250‚Ç¨. En un momento le enviamos el link.", chatbot_accion: "Confirmaci√≥n de Stock"}]
            }
        ];
        
        // ----------------------------------------------------------------------
        // 2. L√ìGICA DE FILTRADO Y RENDERIZADO
        // ----------------------------------------------------------------------
        
        const pedidosList = document.getElementById('pedidos-list');
        const pedidosCount = document.getElementById('pedidos-count');
        const modal = document.getElementById('detail-modal');

        /**
         * Renderiza los pedidos en la vista principal.
         * @param {Array} data - Array de pedidos a renderizar.
         */
        function renderPedidos(data) {
            pedidosList.innerHTML = ''; 
            pedidosCount.textContent = data.length;

            if (data.length === 0) {
                 pedidosList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #999;">No hay pedidos en este estado.</p>';
                 return;
            }

            data.forEach(p => {
                const item = document.createElement('div');
                item.className = 'pedido-item';
                
                // 1. Asignar clase de estado para el borde y el ne√≥n
                const estadoClass = `estado-${p.estado.toLowerCase().replace(/√°/g, 'a')}`; 
                item.classList.add(estadoClass);

                // 2. Hacer el contenedor clickeable
                item.setAttribute('onclick', `showDetail(${p.id})`);

                const clientName = p.clientes.nombre || `(N√∫m: ${p.clientes.numero_whatsapp})`;
                const date = new Date(p.fecha_pedido).toLocaleDateString('es-ES');
                
                // 3. Contenido interno
                item.innerHTML = `
                    <p style="font-size: 1.1em; margin: 0 0 5px 0; color: #c501e2;">
                        ${p.producto_nombre} 
                    </p>
                    <p style="margin: 0 0 5px 0;">
                        Estado: <strong style="color: ${getEstadoColor(p.estado)};">${p.estado}</strong>
                    </p>
                    <p style="margin: 0;">
                        <small>Cliente: ${clientName}</small>
                    </p>
                    <small style="color: #999;">Pedido #${p.id} | ${date}</small>
                `;
                pedidosList.appendChild(item);
            });
        }

        /**
         * L√≥gica principal de filtrado MULTI-SELECCI√ìN.
         */
        function filterPedidos() {
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            
            // 1. Recoger los estados seleccionados (en min√∫sculas)
            const activeFilters = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value); // 'pendiente', 'completada', 'cancelada'
            
            let filteredData;

            if (activeFilters.length === 0) {
                // Si no hay filtros seleccionados, mostramos todos los pedidos.
                filteredData = mockData; 
            } else {
                // 2. Filtrar los datos: El pedido debe COINCIDIR con CUALQUIER filtro activo.
                filteredData = mockData.filter(p => {
                    // Convertir el estado del pedido a min√∫sculas para la comparaci√≥n
                    const normalizedState = p.estado.toLowerCase().replace(/√°/g, 'a');
                    return activeFilters.includes(normalizedState);
                });
            }
            
            renderPedidos(filteredData);
        }

        /**
         * Ayudante para obtener el color de texto seg√∫n el estado.
         */
        function getEstadoColor(estado) {
            if (estado === 'Pendiente') return '#f39c12';
            if (estado === 'Completada') return '#2ecc71';
            if (estado === 'Cancelada') return '#e74c3c';
            return '#e0e0e0';
        }

        // ----------------------------------------------------------------------
        // 3. FUNCIONALIDAD DEL MODAL
        // ----------------------------------------------------------------------
        
        /**
         * Muestra el modal con los datos del pedido seleccionado.
         */
        function showDetail(pedidoId) {
            const pedido = mockData.find(p => p.id === pedidoId);
            if (!pedido) return;

            // Llenar los campos de Detalle
            document.getElementById('modal-title').textContent = `Detalle del Pedido #${pedido.id}`;
            document.getElementById('detail-product').textContent = pedido.producto_nombre;
            document.getElementById('detail-price').textContent = `${pedido.monto.toFixed(2)}‚Ç¨`;
            document.getElementById('detail-status').textContent = pedido.estado;
            document.getElementById('detail-client-name').textContent = pedido.clientes.nombre;
            document.getElementById('detail-client-id').textContent = pedido.clientes.numero_whatsapp;

            // Llenar el Log de Conversaci√≥n
            const logContainer = document.getElementById('detail-conversation-log');
            logContainer.innerHTML = '';
            
            // Revertir el orden para que la conversaci√≥n empiece desde el inicio
            const sortedLogs = [...pedido.logs].reverse(); 

            sortedLogs.forEach(log => {
                const isClient = log.es_entrada;
                const directionClass = isClient ? 'log-cliente' : 'log-bot';
                const directionLabel = isClient ? 'Cliente' : 'Bot';

                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <p style="margin: 0; padding: 0;">
                        <span class="${directionClass}">[${directionLabel}]</span> 
                        ${log.contenido}
                    </p>
                    <small style="color: #999;">Acci√≥n: ${log.chatbot_accion}</small>
                `;
                logContainer.appendChild(logItem);
            });
            
            // Mostrar el Modal
            modal.classList.add('visible');
        }

        /**
         * Oculta el modal.
         */
        function closeModal() {
            modal.classList.remove('visible');
        }

        // ----------------------------------------------------------------------
        // 4. INICIALIZACI√ìN Y LISTENERS
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar todos los pedidos al inicio
            renderPedidos(mockData); 
            
            // Asignar el listener a todos los checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', filterPedidos);
            });

            // Aplicar el filtro inicial (muestra todos, ya que todos est√°n marcados por defecto en el HTML)
            filterPedidos();

            // Permitir cerrar el modal con la tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
