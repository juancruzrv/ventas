<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VISTA PREVIA (GESTI√ìN DE PEDIDOS)</title>
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <div id="dashboard-content" style="display: block;">
    
        <div class="header">
            <h1>üìä Panel de Control del Chatbot</h1>
            <button id="logout-btn">Cerrar Sesi√≥n</button>
        </div>
        
        <div id="status-bar">
            Estado: <span id="message">Vista previa de datos simulados (Gesti√≥n de Pedidos activa)</span>
            
            <div style="margin-top: 10px;">
                <label for="logged-user-select" style="display: inline; font-weight: bold; color: #00fff2;">
                    USUARIO REGISTRADO: 
                </label>
                <select id="logged-user-select" style="padding: 5px; background-color: #2c2c2c; color: #e0e0e0; border: 1px solid #c501e2; border-radius: 3px;">
                    <option value="Usuario A">Usuario A (Gerente)</option>
                    <option value="Usuario B">Usuario B (Asistente)</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>üìà M√©tricas Clave</h3>
            <p class="metric">Pedidos Cargados: <span id="pedidos-count" style="font-weight: bold; color: #00fff2;">0</span></p>
        </div>

        <div class="data-grid">
            
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üõí Pedidos</h3>
                
                <div id="filter-container">
                    
                    <input type="checkbox" id="filter-pendiente" class="filter-checkbox" value="pendiente" checked> 
                    <label for="filter-pendiente" class="filter-checkbox-label">Pendientes</label>

                    <input type="checkbox" id="filter-completada" class="filter-checkbox" value="completada" checked> 
                    <label for="filter-completada" class="filter-checkbox-label">Completadas</label>
                    
                    <input type="checkbox" id="filter-cancelada" class="filter-checkbox" value="cancelada" checked> 
                    <label for="filter-cancelada" class="filter-checkbox-label">Canceladas</label>
                </div>

                <div id="pedidos-list">
                    <p>Cargando pedidos simulados...</p>
                </div>
            </div>
            
        </div>
        
    </div> 

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Detalle del Pedido #</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            
            <h3 style="color: #f39c12;">üéØ Gesti√≥n del Pedido</h3>
            <p>
                Asignado a: <strong id="detail-assigned-user" style="color: #00fff2;"></strong><br>
                √öltima Acci√≥n: <strong id="detail-last-action-date"></strong>
            </p>

            <div id="action-buttons">
                <button id="assign-btn" class="action-btn assign-style" onclick="handleAssignClick()">Tomar Asignaci√≥n</button>
                <button id="complete-btn" class="action-btn complete-style" onclick="actualizarEstado(currentPedidoId, 'Completada')">Marcar como Completado</button>
                <button id="cancel-btn" class="action-btn cancel-style" onclick="actualizarEstado(currentPedidoId, 'Cancelada')">Marcar como Cancelado</button>
            </div>
            
            <h3 style="color: #00fff2;">Informaci√≥n del Pedido</h3>
            <p>
                Producto: <strong id="detail-product"></strong><br>
                Precio: <strong id="detail-price"></strong><br>
                Estado: <strong id="detail-status"></strong><br>
            </p>
            
            <h3 style="color: #00fff2;">Informaci√≥n del Cliente</h3>
            <p>
                Nombre: <strong id="detail-client-name"></strong><br>
                WhatsApp ID: <strong id="detail-client-id"></strong><br>
            </p>

            <h3 style="color: #c501e2;">Transcripci√≥n de la Conversaci√≥n</h3>
            <div id="detail-conversation-log">
                </div>

        </div>
    </div>

    <script>
        let currentPedidoId = null;
        let loggedUser = "Usuario A"; // Inicialmente Usuario A

        // ----------------------------------------------------------------------
        // 1. DATOS SIMULADOS (JSON)
        // ----------------------------------------------------------------------

        let mockData = [
            {
                id: 105,
                producto_nombre: "Oud Ispahan 100ml",
                monto: 120.00,
                estado: "Pendiente",
                fecha_pedido: "2025-11-28T09:30:00Z",
                asignado_a: "Usuario A", 
                fecha_ultima_accion: "2025-11-28T09:30:00Z",
                clientes: { nombre: "Andrea Garc√≠a", numero_whatsapp: "+5491155551234" },
                logs: [{ es_entrada: true, contenido: "S√≠, por favor, me env√≠as el Oud Ispahan. ¬øC√≥mo pago?", chatbot_accion: "Confirmaci√≥n de Compra"}, { es_entrada: false, contenido: "¬°Excelente! Confirmamos que Oud Ispahan est√° en STOCK. ¬øDeseas proceder con la compra por 120‚Ç¨?", chatbot_accion: "Confirmaci√≥n de Stock"}, { es_entrada: true, contenido: "Estoy buscando el perfume Oud Ispahan. ¬øLo tienen?", chatbot_accion: "B√∫squeda de Producto"}, { es_entrada: false, contenido: "Hola Andrea! Soy el Chatbot de Perfumes √Årabes. ¬øEn qu√© puedo ayudarte hoy?", chatbot_accion: "Inicio de Conversaci√≥n"}]
            },
            {
                id: 104,
                producto_nombre: "Shaghaf Oud Aswad",
                monto: 45.00,
                estado: "Completada",
                fecha_pedido: "2025-11-27T18:45:00Z",
                asignado_a: "Usuario B", 
                fecha_ultima_accion: "2025-11-27T20:00:00Z",
                clientes: { nombre: "Ricardo Perez", numero_whatsapp: "+5491166665678" },
                logs: [{ es_entrada: true, contenido: "Recibido, muchas gracias. Ya lo prob√© y me encant√≥.", chatbot_accion: "Feedback Positivo"}, { es_entrada: false, contenido: "Pedido enviado. El n√∫mero de tracking es: T4G56. Que lo disfrutes!", chatbot_accion: "Pedido Enviado"}, { es_entrada: true, contenido: "Quiero el Shaghaf Oud, ya lo compr√© antes.", chatbot_accion: "Recompra Directa"}]
            },
            {
                id: 103,
                producto_nombre: "Yatagan",
                monto: 70.00,
                estado: "Cancelada",
                fecha_pedido: "2025-11-27T10:15:00Z",
                asignado_a: "N/A", 
                fecha_ultima_accion: "2025-11-27T10:30:00Z",
                clientes: { nombre: "Javier L√≥pez", numero_whatsapp: "+5491177779012" },
                logs: [{ es_entrada: true, contenido: "Quiero el perfume Yatagan, sino est√° no me interesa.", chatbot_accion: "Selecci√≥n √önica"}, { es_entrada: false, contenido: "Lo sentimos, Yatagan est√° agotado. ¬øDesea ver otras opciones?", chatbot_accion: "Notificar Agotado"}]
            },
            {
                id: 102,
                producto_nombre: "Oud Wood 50ml",
                monto: 250.00,
                estado: "Pendiente",
                fecha_pedido: "2025-11-28T12:00:00Z",
                asignado_a: "N/A", 
                fecha_ultima_accion: "2025-11-28T12:00:00Z",
                clientes: { nombre: "Laura Gim√©nez", numero_whatsapp: "+5491188883456" },
                logs: [{ es_entrada: true, contenido: "El Oud Wood de 50ml. Estoy esperando el link de pago.", chatbot_accion: "Esperando Pago"}, { es_entrada: false, contenido: "Confirmo stock de Oud Wood. Costo 250‚Ç¨. En un momento le enviamos el link.", chatbot_accion: "Confirmaci√≥n de Stock"}]
            }
        ];
        
        const pedidosList = document.getElementById('pedidos-list');
        const pedidosCount = document.getElementById('pedidos-count');
        const modal = document.getElementById('detail-modal');

        // ----------------------------------------------------------------------
        // 2. L√ìGICA DE ASIGNACI√ìN Y ACTUALIZACI√ìN DE ESTADO
        // ----------------------------------------------------------------------
        
        /**
         * Maneja el clic en el bot√≥n de asignaci√≥n.
         */
        function handleAssignClick() {
            if (currentPedidoId !== null) {
                asignarPedido(currentPedidoId, loggedUser);
            }
        }

        /**
         * Asigna el pedido al usuario logueado.
         */
        function asignarPedido(id, usuario) {
            const pedido = mockData.find(p => p.id === id);
            
            if (pedido && pedido.estado === 'Pendiente') {
                if (pedido.asignado_a === 'N/A') {
                    pedido.asignado_a = usuario;
                    pedido.fecha_ultima_accion = new Date().toISOString();
                    
                    filterPedidos();
                    showDetail(id);
                    alert(`‚úÖ Pedido #${id} tomado y asignado a ${usuario}.`);
                } else if (pedido.asignado_a === usuario) {
                    alert(`‚ÑπÔ∏è El pedido #${id} ya est√° asignado a ti.`);
                } else {
                    alert(`‚ùå El pedido #${id} ya est√° siendo gestionado por ${pedido.asignado_a}. No puedes tomarlo.`);
                }
            } else if (pedido.estado !== 'Pendiente') {
                 alert(`‚ùå El pedido #${id} ya est√° ${pedido.estado} y no puede ser re-asignado.`);
            }
        }

        /**
         * Actualiza el estado de un pedido.
         */
        function actualizarEstado(id, nuevoEstado) {
            const pedido = mockData.find(p => p.id === id);
            
            if (pedido && pedido.estado === 'Pendiente') {
                
                // Permitir finalizar si el usuario lo tiene asignado O si no est√° asignado a nadie
                if (pedido.asignado_a !== loggedUser && pedido.asignado_a !== 'N/A') {
                    alert(`‚ùå No puedes finalizar el pedido #${id}, est√° asignado a ${pedido.asignado_a}.`);
                    return;
                }
                
                pedido.estado = nuevoEstado;
                pedido.fecha_ultima_accion = new Date().toISOString();
                // Si no estaba asignado, se asigna al usuario que lo finaliza
                pedido.asignado_a = pedido.asignado_a !== 'N/A' ? pedido.asignado_a : loggedUser; 
                
                filterPedidos();
                closeModal();
                alert(`üéâ Pedido #${id} marcado como ${nuevoEstado}.`);
            } else if (pedido.estado === nuevoEstado) {
                alert(`‚ÑπÔ∏è El pedido #${id} ya es ${nuevoEstado}.`);
            } else {
                alert(`‚ùå El pedido #${id} ya est√° ${pedido.estado} y no puede ser modificado.`);
            }
        }


        // ----------------------------------------------------------------------
        // 3. L√ìGICA DE FILTRADO Y RENDERIZADO
        // ----------------------------------------------------------------------
        
        function renderPedidos(data) {
            pedidosList.innerHTML = ''; 
            pedidosCount.textContent = data.length;

            if (data.length === 0) {
                 pedidosList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #999;">No hay pedidos en este estado.</p>';
                 return;
            }

            data.forEach(p => {
                const item = document.createElement('div');
                item.className = 'pedido-item';
                
                const estadoClass = `estado-${p.estado.toLowerCase().replace(/√°/g, 'a')}`; 
                item.classList.add(estadoClass);

                item.setAttribute('onclick', `showDetail(${p.id})`);

                const assignedUser = p.asignado_a && p.asignado_a !== 'N/A' ? 
                    `<br><small style="color: #00fff2; font-weight: bold;">Asignado: ${p.asignado_a}</small>` : 
                    `<br><small style="color: #f39c12;">Sin Asignar</small>`;

                const clientName = p.clientes.nombre || `(N√∫m: ${p.clientes.numero_whatsapp})`;
                const date = new Date(p.fecha_pedido).toLocaleDateString('es-ES');
                
                item.innerHTML = `
                    <p style="font-size: 1.1em; margin: 0 0 5px 0; color: #c501e2;">
                        ${p.producto_nombre} 
                    </p>
                    <p style="margin: 0 0 5px 0;">
                        Estado: <strong style="color: ${getEstadoColor(p.estado)};">${p.estado}</strong>
                    </p>
                    <p style="margin: 0;">
                        <small>Cliente: ${clientName}</small>
                        ${assignedUser}
                    </p>
                    <small style="color: #999;">Pedido #${p.id} | ${date}</small>
                `;
                pedidosList.appendChild(item);
            });
        }


        function filterPedidos() {
            const checkboxes = document.querySelectorAll('.filter-checkbox');
            const activeFilters = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value); 
            
            let filteredData;

            if (activeFilters.length === 0) {
                // Si no hay filtros seleccionados, mostramos todos los pedidos.
                filteredData = mockData; 
            } else {
                filteredData = mockData.filter(p => {
                    const normalizedState = p.estado.toLowerCase().replace(/√°/g, 'a');
                    return activeFilters.includes(normalizedState);
                });
            }
            
            renderPedidos(filteredData);
        }

        function getEstadoColor(estado) {
            if (estado === 'Pendiente') return '#f39c12';
            if (estado === 'Completada') return '#2ecc71';
            if (estado === 'Cancelada') return '#e74c3c';
            return '#e0e0e0';
        }

        // ----------------------------------------------------------------------
        // 4. FUNCIONALIDAD DEL MODAL
        // ----------------------------------------------------------------------
        
        function showDetail(pedidoId) {
            const pedido = mockData.find(p => p.id === pedidoId);
            if (!pedido) return;

            currentPedidoId = pedidoId; 

            document.getElementById('modal-title').textContent = `Detalle del Pedido #${pedido.id}`;
            document.getElementById('detail-product').textContent = pedido.producto_nombre;
            document.getElementById('detail-price').textContent = `${pedido.monto.toFixed(2)}‚Ç¨`;
            document.getElementById('detail-status').textContent = pedido.estado;
            document.getElementById('detail-client-name').textContent = pedido.clientes.nombre;
            document.getElementById('detail-client-id').textContent = pedido.clientes.numero_whatsapp;
            
            // Llenar los campos de GESTI√ìN
            const lastActionDate = new Date(pedido.fecha_ultima_accion).toLocaleString('es-ES');
            document.getElementById('detail-assigned-user').textContent = pedido.asignado_a || 'N/A';
            document.getElementById('detail-last-action-date').textContent = lastActionDate;
            
            // Controlar la visibilidad y texto de los botones de acci√≥n
            const assignBtn = document.getElementById('assign-btn');
            const completeBtn = document.getElementById('complete-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            assignBtn.textContent = `Asignarme (${loggedUser})`;

            if (pedido.estado === 'Pendiente') {
                completeBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                
                // Si no est√° asignado O est√° asignado al usuario logueado
                if (pedido.asignado_a === 'N/A' || pedido.asignado_a === loggedUser) {
                    assignBtn.classList.remove('hidden');
                    assignBtn.disabled = false;
                    completeBtn.disabled = false;
                    cancelBtn.disabled = false;

                    if (pedido.asignado_a === loggedUser) {
                        assignBtn.classList.add('hidden'); // Ocultar si ya lo tiene el usuario logueado
                    }

                } else {
                    // Asignado a OTRA PERSONA
                    assignBtn.classList.add('hidden'); 
                    completeBtn.disabled = true; // Deshabilitar si no es su asignaci√≥n
                    cancelBtn.disabled = true;  // Deshabilitar si no es su asignaci√≥n
                }
            } else {
                // Si ya est√° Completada o Cancelada
                assignBtn.classList.add('hidden');
                completeBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
            }


            // Llenar el Log de Conversaci√≥n
            const logContainer = document.getElementById('detail-conversation-log');
            logContainer.innerHTML = '';
            const sortedLogs = [...pedido.logs].reverse(); 

            sortedLogs.forEach(log => {
                const isClient = log.es_entrada;
                const directionClass = isClient ? 'log-cliente' : 'log-bot';
                const directionLabel = isClient ? 'Cliente' : 'Bot';

                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <p style="margin: 0; padding: 0;">
                        <span class="${directionClass}">[${directionLabel}]</span> 
                        ${log.contenido}
                    </p>
                    <small style="color: #999;">Acci√≥n: ${log.chatbot_accion}</small>
                `;
                logContainer.appendChild(logItem);
            });
            
            modal.classList.add('visible');
        }

        function closeModal() {
            modal.classList.remove('visible');
        }

        // ----------------------------------------------------------------------
        // 5. INICIALIZACI√ìN Y LISTENERS
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            const userSelect = document.getElementById('logged-user-select');
            
            loggedUser = userSelect.value;

            userSelect.addEventListener('change', (e) => {
                loggedUser = e.target.value;
                document.getElementById('message').textContent = `Usuario logueado cambiado a: ${loggedUser}.`;
                if(currentPedidoId !== null && modal.classList.contains('visible')) {
                    showDetail(currentPedidoId);
                }
            });


            renderPedidos(mockData); 
            
            // Listener para los checkboxes de filtro
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', filterPedidos);
            });

            filterPedidos();

            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
